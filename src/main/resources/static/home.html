<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home</title>
    <link rel="stylesheet" href="bulma.css">
    <script src="https://unpkg.com/htmx.org@1.9.3"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/client-side-templates.js"></script>
    <script src="https://unpkg.com/nunjucks@latest"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/response-targets.js"></script>
    <script src="templates/javascript-helpers.js"></script>


</head>

<body hx-ext="client-side-templates,response-targets,json-enc">
<div hx-trigger="load"
     hx-get="http://localhost:8080/user"
     nunjucks-template="main-template"
     hx-target-4*="#main"
     hx-target="#main"
     id="main">
</div>

<template id="main-template">

    {% include "templates/check-session-invalid.html" %}
    {% include "templates/navbar.html" %}

    {% if admin %}
    <div hx-get="http://localhost:8080/posts"
         hx-target="#adminOutput"
         nunjucks-template="templateAdmin"
         hx-trigger="load">
    </div>
    <section id="adminOutput"></section>

    {% else %}
    <div hx-get="http://localhost:8080/posts"
         hx-target="#userOutput"
         nunjucks-template="templateUser"
         hx-trigger="load">
    </div>
    <section id="userOutput"></section>

    {% endif %}

</template>

<template id="templateAdmin">

    {% for blogPost in blogPostList %}

    <div class="container">
        <div class="card">
            <div class="card-content">
                <article class="media">
                    <figure class="media-left">
                        <p class="image is-64x64">
                            <img src="https://bulma.io/images/placeholders/128x128.png">
                        </p>
                    </figure>
                    <div class="media-content">
                        <div class="content">
                            <p>
                                <strong>{{blogPost.user.username}}</strong> <small>{{blogPost.blogPostTime}}</small>
                                <br>
                                {{blogPost.content}}
                                <br>
                                <small><a>Like</a> · <a>Edit</a> · <a>Delete</a> </small>
                            </p>
                        </div>

                        <!----------Hier beginnen die Kommentare!!!!--->

                        {% for comment in blogPost.comments %}
                        <article class="media">
                            <figure class="media-left">
                                <p class="image is-48x48">
                                    <img src="https://bulma.io/images/placeholders/96x96.png">
                                </p>
                            </figure>
                            <div class="media-content">
                                <div class="content">
                                    <p>
                                        <strong>{{comment.user.username}}</strong>
                                        <small>{{comment.commentTime}}</small>
                                        <br>
                                        {{comment.comment}}
                                        <br>
                                        <small><a>Like</a> · <a>Edit</a> · <a>Delete</a> </small>
                                    </p>
                                </div>
                            </div>
                        </article>
                        {% endfor %}
                        <section class="commentsAdmin"></section>
                    </div>
                </article>


                <!----------Hier beginnt das Kommentarfeld!!!!-->
                <article class="media">
                    <figure class="media-left">
                        <p class="image is-64x64">
                            <img src="https://bulma.io/images/placeholders/128x128.png">
                        </p>
                    </figure>
                    <div class="media-content">

                        <form action="" hx-post="http://localhost:8080/posts/{{blogPost.id}}/comments"
                              nunjucks-template="templateComment"
                              hx-target="previous .commentsAdmin"
                              hx-swap="afterend">

                            <div class="field">
                                <p class="control">
                                    <textarea class="textarea is-small" name="comment"
                                              placeholder="Add a comment..."></textarea>
                                </p>
                            </div>

                            <nav class="level">
                                <div class="level-left">
                                    <div class="level-item">
                                        <button type="submit" class="commentSubmitButton button is-info">Comment
                                        </button>
                                    </div>
                                </div>
                            </nav>
                        </form>
                    </div>
                </article>
            </div>

            </article>
        </div>
    </div>
    <br>
    </div>
    {% endfor %}
</template>

<template id="templateUser"></template>

<template id="templateComment">
    <article class="media">
        <figure class="media-left">
            <p class="image is-48x48">
                <img src="https://bulma.io/images/placeholders/96x96.png">
            </p>
        </figure>
        <div class="media-content">
            <div class="content">
                <p>
                    <strong>{{user.username}}</strong> <small>{{commentTime}}</small>
                    <br>
                    {{comment}}
                    <br>
                    <small><a>Like</a> · <a>Edit</a> · <a>Delete</a> </small>
                </p>
            </div>
        </div>
    </article>
    </div>
    </article>
</template>

<footer class="footer">
    <div class="content has-text-centered">
        <p>
            <strong>Bulma</strong> by <a href="https://jgthms.com">Jeremy Thomas</a>. The source code is licensed
            <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. The website content
            is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
        </p>
    </div>
</footer>
</body>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        setTimeout(function () {
            let commentSubmitButtons = document.getElementsByClassName("commentSubmitButton")
            for (let commentSubmitButton of commentSubmitButtons) {
                commentSubmitButton.addEventListener("click", () => {
                    setTimeout(function () {
                        let commentTextareas = document.getElementsByTagName("textarea")
                        for (textarea of commentTextareas){
                            textarea.value = ""
                        }
                    }, 10);

                })
            }
        }, 300);

    })
</script>
</html>